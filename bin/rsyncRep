#!/bin/bash
#
# Brief description of your script
# Copyright 2022 bombi

function main() {

  # $1 = commit

  if [[ -n "$1" ]];
  then

    pwd &> ../pwdInstall.txt

    cd userRep || exit

    git config --global --add --bool push.autoSetupRemote true

    git fetch &> ../firstFetch.txt

    git checkout -b main

    git fetch &> ../secondFetch.txt

    git pull -f origin main &> ../pullMain.txt

    # back to githolder
    cd ..

    ls -a userRep &> showFolderBeforeRemove.txt

    # alles aus userRep löschen
    rm -rf userRep/*

    ls -a userRep &> showFolderAfterRemove.txt

    cd userRep || exit
    git rm -rf .

    git commit -m "$1 - first round - delete"

    git status &> ../statusAfterCommit.txt

    # leeren  Branch pushen
    git push -u

    # back to githolder
    cd ..

    mkdir backup
    mv userRep/.git backup/.git

    # holen von Partarum ins userRep
    rsync -a -p --exclude-from=rsync_exclude Partarum/. userRep &> logRsync.txt

    mv backup/.git userRep/.git

    cd userRep || exit

    git config user.name "Partarum"
    git config user.email "email@partarum.de"

    git add --all API/
    git add --all app/
    git add --all cli/
    git add --all config/
    git add --all Partarum/
    git add --all public/

    git add .gitignore
    git add .htaccess
    git add composer.json
    git add composer.lock
    git add index.php
    git add LICENSE
    git add README.md

    echo "Hinzufügen der Commits:"
    git commit -m "$1" &> ../finishCommit.txt

    git remote -v &> ../finishRemote.txt

    git status &> ../finishStatus.txt

    git branch &> ../finishBranch.txt

    # aktuelles userRep mit Partarum nach main pushen
    git push -u &> ../finishPush.txt

    git status &> ../finishStatusAfterPush.txt

    # back to githolder
    cd ..
    # back to .partarumGhost
    cd ..

    # übertragen der eigentlich vorhandenen User - Dateien ins UserRep
    rsync -a baseHolder/. gitHolder/userRep

    # back to user folder
    cd ..

    mkdir .partarumGhost/gitHolder/userRep/.partarumGhost

    rsync -a .partarumGhost/. .partarumGhost/gitHolder/userRep/.partarumGhost

    cd .partarumGhost/gitHolder/userRep || exit

    git status &> ../afterFinishStatus.txt

    git add --all .partarumGhost/

    git commit -m "add partarumGhost"

    git status &> ../afterFinishCommitStatus.txt

    git push -u &> ../afterFinishPush.txt

    git status &> ../afterFinishPushStatus.txt


    #for file in .* *;
    #do
     # if [[ $file != ".partarumGhost" ]];
      #then
       # rm -rf "$file"
      #fi
    #done


    #rsync -a .partarumGhost/gitHolder/userRep .

  else
    echo "Du hast den Commit vergessen" &> noCommit.txt
  fi

    # add remot
    # pull and push
}

main "$@"